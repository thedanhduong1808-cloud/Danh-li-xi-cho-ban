<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VÃ²ng Quay May Máº¯n</title>

<style>
body{
    text-align:center;
    font-family:Arial;
    background:linear-gradient(135deg,#4facfe,#00f2fe);
    color:white;
}
input{
    padding:8px;
    margin:5px;
}
button{
    padding:8px 15px;
    margin:5px;
    cursor:pointer;
}
#wheel{
    margin-top:20px;
    border-radius:50%;
    background:white;
}
.arrow{
    font-size:40px;
    color:red;
}
</style>
</head>
<body>

<h2>ÄÄƒng kÃ½ / ÄÄƒng nháº­p</h2>

<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Máº­t kháº©u">
<br>
<button onclick="register()">ÄÄƒng kÃ½</button>
<button onclick="login()">ÄÄƒng nháº­p</button>
<button onclick="logout()">ÄÄƒng xuáº¥t</button>

<h3 id="userStatus"></h3>

<hr>

<h1>ğŸ‰ VÃ²ng Quay May Máº¯n ğŸ‰</h1>

<div class="arrow">â¬‡</div>
<canvas id="wheel" width="400" height="400"></canvas>
<br>
<button onclick="spin()">Quay</button>

<h2 id="result"></h2>

<script type="module">

/* ================= FIREBASE ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword,
signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { getFirestore, collection, addDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”¥ DÃN firebaseConfig Cá»¦A Báº N VÃ€O ÄÃ‚Y */
const firebaseConfig = {
  apiKey: "AIzaSyBEoRoIy8kk85Iw4OtQSFFLIAHmxXjc9f4",
  authDomain: "danh-li-xi-cho-ban.firebaseapp.com",
  projectId: "danh-li-xi-cho-ban",
  storageBucket: "danh-li-xi-cho-ban.firebasestorage.app",
  messagingSenderId: "1018960097479",
  appId: "1:1018960097479:web:8a2e0f9efaad2da8d94ee2",
  measurementId: "G-X244HN9JMV"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= AUTH ================= */

window.register = function(){
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    createUserWithEmailAndPassword(auth,email,password)
    .then(()=>alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng"))
    .catch(e=>alert(e.message));
}

window.login = function(){
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    signInWithEmailAndPassword(auth,email,password)
    .then(()=>alert("ÄÄƒng nháº­p thÃ nh cÃ´ng"))
    .catch(e=>alert(e.message));
}

window.logout = function(){
    signOut(auth);
}

onAuthStateChanged(auth,(user)=>{
    if(user){
        document.getElementById("userStatus").innerText =
            "Äang Ä‘Äƒng nháº­p: " + user.email;
    }else{
        document.getElementById("userStatus").innerText =
            "ChÆ°a Ä‘Äƒng nháº­p";
    }
});

/* ================= VÃ’NG QUAY ================= */

const prizes = [
    "20.000Ä‘",
    "30.000Ä‘",
    "50.000Ä‘",
    "80.000Ä‘",
    "100.000Ä‘",
    "150.000Ä‘",
    "200.000Ä‘"
];

const probabilities = [20,20,28,15,10,5,2];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

const numSegments = prizes.length;
const angle = 2*Math.PI/numSegments;

let currentRotation = 0;
let isSpinning = false;

function drawWheel(){
    for(let i=0;i<numSegments;i++){
        ctx.beginPath();
        ctx.moveTo(200,200);
        ctx.arc(200,200,200,i*angle,(i+1)*angle);
        ctx.fillStyle = `hsl(${i*50},70%,50%)`;
        ctx.fill();

        ctx.save();
        ctx.translate(200,200);
        ctx.rotate(i*angle + angle/2);
        ctx.fillStyle="white";
        ctx.font="16px Arial";
        ctx.fillText(prizes[i],60,5);
        ctx.restore();
    }
}

function getRandomPrize(){
    const random = Math.random()*100;
    let sum=0;
    for(let i=0;i<probabilities.length;i++){
        sum+=probabilities[i];
        if(random<=sum) return i;
    }
    return 0;
}

window.spin = async function(){
    if(isSpinning) return;

    const user = auth.currentUser;
    if(!user){
        alert("Báº¡n pháº£i Ä‘Äƒng nháº­p trÆ°á»›c!");
        return;
    }

    isSpinning=true;

    const index = getRandomPrize();
    const extra = 5*2*Math.PI;

    const target =
        (3*Math.PI/2) - (index*angle + angle/2);

    const finalRotation = currentRotation + extra + target;

    animate(finalRotation,index);
}

function animate(finalRotation,index){
    const duration=4000;
    const start=performance.now();

    function frame(time){
        const progress=Math.min((time-start)/duration,1);
        const ease=1-Math.pow(1-progress,3);

        currentRotation=ease*finalRotation;

        ctx.clearRect(0,0,400,400);
        ctx.save();
        ctx.translate(200,200);
        ctx.rotate(currentRotation);
        ctx.translate(-200,-200);
        drawWheel();
        ctx.restore();

        if(progress<1){
            requestAnimationFrame(frame);
        }else{
            const prize = prizes[index];
            document.getElementById("result").innerText =
                "ğŸŠ Báº¡n trÃºng: "+prize;

            saveResult(prize);
            isSpinning=false;
        }
    }
    requestAnimationFrame(frame);
}

async function saveResult(prize){
    const user = auth.currentUser;
    await addDoc(collection(db,"spin_results"),{
        email:user.email,
        prize:prize,
        time:new Date()
    });
}

drawWheel();

</script>

</body>
</html>
